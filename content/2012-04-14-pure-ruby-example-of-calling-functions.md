---
layout: post
title: "Pure Ruby example of calling functions from the MS IUIAutomation COM interface"
date: 2012-04-14T04:35:00-07:00
categories:
 - ruby
 - windows-pr
 - iuiautomation
 - windows
 - com
---

<div class='post'>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-rdW25qgHSN8/T4ljdW-fsaI/AAAAAAAAAGs/jzMQl28ee-Q/s1600/cmd.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="123" width="400" src="http://4.bp.blogspot.com/-rdW25qgHSN8/T4ljdW-fsaI/AAAAAAAAAGs/jzMQl28ee-Q/s400/cmd.png" /></a></div><br />A while back I was interested in writing some Ruby code that used functions from the Windows <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ee671406(v=vs.85).aspx">IUIAutomation COM interface</a>.<br /><br />But since IUIAutomation is a custom COM interface that doesn't implement <a href="http://en.wikipedia.org/wiki/IDispatch">IDispatch</a>, Ruby's Win32OLE module won't work with it.<br /><br />And I wanted to avoid using a C extension that wraps UI Automation - see <a href="https://github.com/jarmo/RAutomation">RAutomation</a> for an example of a nice library that takes the C extension approach.<br /><br />Without using a C extension, the only way I've found to use IUIAutomation in Ruby is to use Windows::COM - which is included in the awesome <a href="https://github.com/djberg96/windows-pr">windows-pr</a> project.<br /><br />Then, one must pore over the C header file containing the function prototypes you want to use (UIAutomationClient.h in this case) and port each prototype to Ruby one at a time (!).<br /><br />Note you have to install the <a href="http://www.microsoft.com/download/en/details.aspx?id=3138">the Windows 7 SDK</a> to get a copy of that header file, but you don't need the SDK or .h to simply run the Ruby script shown below.<br /><br />(For what it's worth, my copy of the header file is at \Program Files\Microsoft SDKs\Windows\v7.1\Include\UIAutomationClient.h)<br /><br />This is all quite a far cry from how easy the same task is in the CPython world thanks to <a href="http://starship.python.net/crew/theller/comtypes/">comtypes</a>.  But I digress - doing the same thing in Python deserves its own post.<br /><br />Below is a Ruby script that obtains and prints the name of the root (Desktop) UI automation element on a Windows box - the string should always be "Desktop".<br /><br />Doing so shows how to use IUIAutomation::GetRootElement() and IUIAutomationElement::get_CurrentName().<br /><br />Apologies for the convoluted hacks on display - stuff like having to hardcode the number of each function in the IUIAutomationVtbl struct will hopefully have a better solution someday!<br /><br />NOTE: Before running this you must:<br /><br />- Do a "gem install windows-pr"<br />- If you're using XP or Vista, install the <a href="http://support.microsoft.com/kb/971513">Windows Automation API</a> update from MS<br /><br /><script src="https://gist.github.com/2383726.js?file=print_root_element_name.rb"></script></div>
